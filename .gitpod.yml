# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/config-gitpod-file)
# and commit this file to your remote git repository to share the goodness with others.

tasks:
  - name: Install Terraform CLI
    init: |
      wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
      sudo apt update && sudo apt install terraform
  - name: Install Digital Ocean CLI
    init: |
      wget https://github.com/digitalocean/doctl/releases/download/v1.78.0/doctl-1.78.0-linux-amd64.tar.gz -P ~/
      tar xf ~/doctl-1.78.0-linux-amd64.tar.gz
      sudo mv ~/doctl /usr/local/bin

  - name: Prepare credentials file
    init: |
      cp scripts/util/credentials.sample.toml credentials.toml

  - name: Install Python Dependencies
    init: pip install -r requirements.txt

  - name: Check if SSH env vars exist and set them
    command: |
      echo "check for ssh key env var"
      if [ -z ${github_ssh_key+x} ]; 
        then
          echo "ssh key does not exist"
          # var does not exist 
          :
        else
          echo "ssh key exists!"
          echo $github_ssh_key_base64 | tr " " "\n" | base64 --decode >> /home/gitpod/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
      fi

  - name: Set up git aliases
    command: |
      git config --global alias.co checkout
      git config --global alias.br branch
      git config --global alias.ci commit
      git config --global alias.st status
